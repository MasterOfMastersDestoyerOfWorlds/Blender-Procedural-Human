---
description: Validate Blender addon code by checking terminal for errors
globs: procedural_human/**/*.py
alwaysApply: false
---

# Blender Addon Validation

After modifying geometry node groups or operators, always verify they load correctly:

1. Check the Blender terminal for errors after addon reload
2. Look for patterns like:
   - `Error creating node group`
   - `KeyError` or `key "..." not found`
   - `AttributeError` 
   - `TypeError`

## Node Group Reload Pattern

Use `get_or_rebuild_node_group()` from `node_helpers.py` for all geometry node groups.
This pattern:
- Creates node groups on first call
- Clears and rebuilds on first call after addon reload (preserves references)
- Returns cached version on subsequent calls within the same session

```python
from procedural_human.geo_node_groups.node_helpers import get_or_rebuild_node_group

def create_my_node_group():
    group_name = "MyNodeGroup"
    group, needs_rebuild = get_or_rebuild_node_group(group_name)
    if not needs_rebuild:
        return group
    
    # Build interface and nodes...
    group.interface.new_socket(...)
    # ...
    return group
```

## Common Socket Issues (Blender 4.x)

Many nodes use indexed socket access instead of named access:

GeometryNodeCaptureAttribute:
- `inputs[0]` - Geometry input
- `inputs[1]` - Value to capture
- `outputs[0]` - Geometry output
- `outputs[1]` - Captured attribute

GeometryNodeMeshBoolean:
- `inputs[0]` - Mesh 1
- `inputs[1]` - Mesh 2

WARNING: Using wrong socket index will cause unexpected behavior or errors!

## Validation Workflow

1. If Blender is not running, start it with `python tools/blender_cli.py start`
2. After geo node edits, run the primary validation command:
   - `python tools/blender_cli.py validate --group <GroupName>`
3. Check returned JSON and ensure all checks pass:
   - Geometry exists (`vertex_count >= 2` and `face_count >= 1`)
   - Watertight passes by default (or intentionally disabled for open meshes)
   - Degenerate check passes (not collapsed to line/point)
   - Camera visibility passes
4. Review the returned screenshot path and visually confirm output matches intent
5. If Blender is unresponsive, run `python tools/blender_cli.py restart`

## CLI Command Design

Every server-side check must be exposed as its own `@cli_command` so users
and agents can compose arbitrary pipelines. Higher-level commands (`preflight`,
`validate`) compose these atomic commands — they never call `client.command()`
for something that should be independently runnable.

### Atomic commands (each usable standalone)

| Command | Purpose |
|---------|---------|
| `validate-geometry` | vertex count >= 2, face count >= 1 |
| `check-watertight` | all edges manifold |
| `check-degenerate` | not collapsed to point/line |
| `check-camera-visibility` | bounding box in camera frustum |
| `screenshot` | render scene to PNG |
| `mesh-metrics` | counts, dimensions, face histogram |
| `apply-node-group` | create object with geo node group |
| `reload` | clean scene + re-enable addon |
| `exec` | arbitrary `bpy` code |

### Composite commands (compose the above)

| Command | Steps |
|---------|-------|
| `preflight` | validate-geometry → check-watertight → check-degenerate → check-camera-visibility → screenshot |
| `validate` | reload → apply-node-group → preflight |

### Adding a new check

1. Add a handler in `blender_server.py` (server-side)
2. Add an `@cli_command` in `tools/commands/` (client-side, standalone)
3. Optionally compose it into `preflight` / `validate`
