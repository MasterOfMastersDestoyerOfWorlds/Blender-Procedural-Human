---
title: Dynamic-socket nodes need item definitions before socket access
category: blender-api
severity: critical
modules: [geo_node_groups, node_exporter]
tags: [blender, sockets, repeat-zone, capture-attribute, exporter]
---

## Context

Several geometry node types have **dynamic sockets** managed through item
collections. The node exporter (`node_exporter.py`) doesn't export the
item definitions — it only exports the socket indices as they exist at
runtime. When the exported code runs, the custom sockets don't exist yet.

## Decision

For nodes with dynamic sockets, define items BEFORE accessing custom
sockets. The correct pattern for each node type:

**Repeat zones** — define items on the Output node, then pair:
```python
repeat_output = nodes.new("GeometryNodeRepeatOutput")
repeat_output.repeat_items.new("BOOLEAN", "Top")
repeat_output.repeat_items.new("FLOAT", "Value")
repeat_input = nodes.new("GeometryNodeRepeatInput")
repeat_input.pair_with_output(repeat_output)
# NOW inputs[2] ("Top") and inputs[3] ("Value") exist
```

**Capture Attribute** — define items directly:
```python
capture = nodes.new("GeometryNodeCaptureAttribute")
capture.capture_items.new(socket_type='FLOAT_VECTOR', name='Normal')
# NOW inputs[1] and outputs[1] exist for the "Normal" item
```

**ForEach Geometry Element** — define items on Output, then pair:
```python
foreach_output = nodes.new("GeometryNodeForeachGeometryElementOutput")
foreach_output.input_items.new("FLOAT", "Weight")
foreach_output.main_items.new("GEOMETRY", "Result")
foreach_input = nodes.new("GeometryNodeForeachGeometryElementInput")
foreach_input.pair_with_output(foreach_output)
```

**Menu Switch** — define enum items before accessing value inputs:
```python
menu_switch = nodes.new("GeometryNodeMenuSwitch")
menu_switch.data_type = "INT"
menu_switch.enum_items.clear()
menu_switch.enum_items.new("X")
menu_switch.enum_items.new("Y")
menu_switch.enum_items.new("Z")
# NOW inputs[1], inputs[2], inputs[3] exist
# Copy enum to interface socket:
menu_socket.from_socket(menu_switch, menu_switch.inputs[0])
menu_socket.default_value = "X"
```

## Evidence

- `shoulders.py:333` — `repeat_input.inputs[3]` failed because
  `repeat_items` were never defined on the paired output.
- `gold_wavies.py:45`, `gold_on_band.py:59`, `gem_in_holder.py:145` —
  same pattern, all repeat zones missing item definitions.
- `loft_spheroid.py:839` — `NodeSocketMenu.default_value = "X"` failed
  because the enum was empty (no items defined on the menu switch).
- Hand-written code in `charrot_gregory_patch.py` does this correctly.

## Reuse trigger

Any time autogenerated Blender Python accesses indexed sockets on
RepeatInput/Output, CaptureAttribute, ForEachGeometryElement, or
MenuSwitch — the item definitions must be added before the socket access.

## Anti-pattern

Do NOT shift socket indices to "fix" out-of-range errors on these nodes.
The indices are correct; the items that CREATE the sockets are missing.
The previous version of this learning incorrectly attributed the problem
to "Blender 5 changing socket indices" — the real cause is the exporter
not exporting item definitions.
